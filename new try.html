<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <!--
    Birthday Countdown â€” Pink Lilies â€¢ Deluxe Singleâ€‘File Site
    -----------------------------------------------------------------
    Goals (from user):
    â€¢ Keep everything from previous versions
    â€¢ Pink theme, lily decorations
    â€¢ No next/prev nav visible; auto-cycles days automatically
    â€¢ Super interactive and polished (600+ lines), productionâ€‘quality

    Highlights:
    â€¢ Live timezone-accurate countdown (Asia/Kathmandu)
    â€¢ Smart photo loader: tries /photos, /img, and root with 3 numbering schemes
      (days-left; since-start from 0; since-start from 1) and multiple extensions
    â€¢ Auto advance between days (configurable) with smooth transitions and preloading
    â€¢ Confetti on birthday + floating lily petal particles
    â€¢ Parallax hover effect on hero image (reduced-motion aware)
    â€¢ Share/copy private daily link, theme toggle, settings modal (speed/theme/petals)
    â€¢ Progressive Web App (inline Service Worker registration + caching)
    â€¢ Accessibility: ARIA, prefers-reduced-motion, focus styles, keyboard traps for dialog
    â€¢ Offline-friendly: caches shell and images upon first view
    â€¢ Clean architecture: modular sections in JS with clear comments

    NOTE: This is intentionally verbose and wellâ€‘commented for maintainability.
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riya â€” Birthday Countdown â€¢ Pink Lilies Deluxe</title>
  <meta name="description" content="A deluxe, singleâ€‘file birthday countdown with a soft pink lilies theme, live timer, auto day cycling, confetti, petal particles, share tools, and offline caching." />
  <meta name="robots" content="index,follow" />
  <meta name="theme-color" content="#ff4f9a" />
  <link rel="canonical" href="." />
  <style>
    /* =====================================================================
       1) CSS RESET & BASE
       ===================================================================== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; line-height: 1.5; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
    img, canvas, svg { display: block; max-width: 100%; }
    button, input, select, textarea { font: inherit; color: inherit; }
    :focus-visible { outline: 2px solid #b23c74; outline-offset: 2px; }

    /* =====================================================================
       2) THEME TOKENS â€” Pink-first palette (with dark variant)
       ===================================================================== */
    :root{
      --bg: #fff7fb;           /* background */
      --card: #ffffff;         /* surfaces */
      --ink: #1d1a22;          /* primary text */
      --muted: #7a6b79;        /* secondary text */
      --ring: #ffd7ea;         /* borders / rings */
      --accent: #ff4f9a;       /* primary accent */
      --accent-2: #ffd8e9;     /* light accent */
      --accent-3: #ffe9f3;     /* even lighter accent for soft gradients */
      --ok: #2fb170;           /* success */
      --warn: #efb33a;         /* warning */
      --err: #e05866;          /* error */
      --shadow: 0 22px 70px rgba(255,79,154,.22);
      --radius-3xl: 28px; --radius-2xl: 22px; --radius-xl: 16px; --radius-md: 12px; --radius-sm: 8px;
      --maxw: 1080px;
    }
    [data-theme="dark"]{
      --bg: #0f0b11;
      --card: #17131b;
      --ink: #f5eef6;
      --muted: #b7a9b6;
      --ring: #392737;
      --accent: #ff6aa9;
      --accent-2: #3a2031;
      --accent-3: #23151f;
      --shadow: 0 28px 80px rgba(0,0,0,.45);
    }

    /* Background with large, subtle gradients + lily petal layer beneath card */
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 85% -10%, var(--accent-2), transparent),
        radial-gradient(900px 600px at -20% 110%, #ffe6f1, transparent),
        var(--bg);
    }

    .wrap{ min-height: 100%; display: grid; place-items: center; padding: 28px; position: relative; }

    /* subtle animated background shimmer (reducedâ€‘motion aware) */
    .bg-shimmer { position: fixed; inset: 0; pointer-events: none; mix-blend-mode: soft-light; opacity: .25; }
    .bg-shimmer::before { content: ""; position: absolute; inset: 0; background: radial-gradient(1000px 700px at 10% 10%, var(--accent-3), transparent); }
    @media (prefers-reduced-motion: no-preference){
      .bg-shimmer { animation: shimmer 16s ease-in-out infinite alternate; }
      @keyframes shimmer { from { filter: hue-rotate(0deg) } to { filter: hue-rotate(8deg) } }
    }

    /* =====================================================================
       3) CARD LAYOUT
       ===================================================================== */
    .card{
      position: relative; background: var(--card); border: 1px solid var(--ring); box-shadow: var(--shadow);
      width: min(var(--maxw), 100%); border-radius: var(--radius-3xl); overflow: clip;
      backdrop-filter: saturate(1.02);
    }

    /* Decorative lilies hugging the card corners */
    .lily{ position: absolute; opacity: .17; pointer-events: none; filter: drop-shadow(0 10px 18px rgba(255,79,154,.25)) }
    .lily-1{ top: -34px; right: -18px; width: 260px; transform: rotate(10deg) }
    .lily-2{ bottom: -32px; left: -10px; width: 280px; transform: rotate(-8deg) }
    .lily g { transform-origin: center; }
    @media (prefers-reduced-motion: no-preference){
      .lily g{ animation: floaty 3.8s ease-in-out infinite alternate }
      @keyframes floaty { from{ transform: translateY(0) } to{ transform: translateY(-10px) } }
    }

    /* =====================================================================
       4) HEADER
       ===================================================================== */
    header{
      display: grid; grid-template-columns: 1fr auto; gap: 14px; align-items: center;
      padding: 18px 22px; border-bottom: 1px solid var(--ring);
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--accent-3) 70%, transparent), transparent);
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0 }
    .logo{ width: 46px; height: 46px; border-radius: 50%; background: conic-gradient(from 0deg, var(--accent), #ffc5dd, var(--accent)); box-shadow: 0 6px 16px rgba(255,79,154,.35) }
    h1{ margin:0; font-size: 20px; letter-spacing:.2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .actions{ display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end }
    .days{ display:flex; align-items: baseline; gap: 8px; font-variant-numeric: tabular-nums }
    .days .big{ font-size: 42px; font-weight: 800; color: var(--accent) }
    .days .label{ color: var(--muted) }

    .timer{ display:flex; align-items:center; gap:10px; color:var(--muted); font-variant-numeric:tabular-nums }
    .timer .chunk{ display:inline-flex; align-items:baseline; gap:6px }
    .timer .num{ font-weight: 800; color: var(--ink) }
    .timer .unit{ font-size: 12px }

    .btn{ appearance:none; border:1px solid var(--ring); background:transparent; color:var(--ink);
      padding:8px 12px; border-radius: 999px; cursor:pointer; font-weight:700; transition: transform .15s ease; }
    .btn:hover{ transform: translateY(-1px) }
    .btn[aria-pressed="true"]{ background: color-mix(in oklab, var(--accent-2) 80%, transparent) }

    /* =====================================================================
       5) HERO SECTION â€” image, overlay badge, canvas FX
       ===================================================================== */
    .hero{ position: relative }
    figure{ margin: 0; position: relative; background: color-mix(in oklab, var(--card) 75%, var(--accent-2)); overflow: hidden }
    .photo{ width: 100%; aspect-ratio: 4/5; object-fit: cover; object-position: 50% 40%; display:block; background:#f5eef3; transition: transform .35s ease }
    .photo.parallax{ transform: perspective(1200px) rotateX(var(--rx)) rotateY(var(--ry)) scale(1.02) }

    .badge{ position:absolute; top:14px; left:14px; background: color-mix(in oklab, var(--card) 90%, transparent);
      border:1px solid var(--ring); padding:6px 10px; border-radius:999px; font-weight:800; color:#b23c74;
      backdrop-filter: blur(6px); display:flex; gap:8px; align-items:center }
    .badge svg{ width:16px; height:16px }

    /* no visible nav arrows (per user) */
    .nav-arrow{ display:none }

    /* Canvas overlay for confetti + petal particles */
    #fx, #petals { position:absolute; inset:0; pointer-events:none }

    /* =====================================================================
       6) CONTENT
       ===================================================================== */
    .content{ padding: 20px 22px 22px; display:grid; gap:14px }
    .date-line{ display:flex; align-items:center; gap:10px; color:var(--muted) }
    .dot{ width:6px; height:6px; border-radius:999px; background:var(--accent) }

    .message-wrap{ position: relative; }
    .message{ font-size:22px; line-height:1.6; opacity: 1; transform: translateY(0); transition: opacity .35s ease, transform .35s ease }
    .message.leaving{ opacity: 0; transform: translateY(6px) }

    .progress-bar{ height: 10px; border-radius: 999px; background: linear-gradient(90deg, var(--accent-2), transparent); position:relative; overflow:hidden; border:1px solid var(--ring) }
    .progress{ position:absolute; inset:0; width:0%; background: linear-gradient(90deg, var(--accent), var(--ok)); }

    .controls{ display:flex; gap:8px; flex-wrap:wrap }

    .footer{ padding: 16px 22px 22px; border-top:1px solid var(--ring); color:var(--muted); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px }

    @media (max-width: 720px){
      header{ grid-template-columns: 1fr; grid-auto-rows: min-content }
      .timer{ justify-content: flex-start }
      .days .big{ font-size: 36px }
    }

    /* =====================================================================
       7) SETTINGS DIALOG (modal)
       ===================================================================== */
    .modal{ position: fixed; inset: 0; display: none; place-items: center; background: color-mix(in oklab, black 40%, transparent); padding: 20px }
    .modal[open]{ display: grid }
    .sheet{ width: min(560px, 96vw); background: var(--card); color: var(--ink); border: 1px solid var(--ring); border-radius: var(--radius-2xl); box-shadow: var(--shadow); overflow: clip }
    .sheet header{ display:flex; align-items:center; justify-content: space-between; border-bottom: 1px solid var(--ring) }
    .sheet h2{ font-size: 18px; margin: 0 }
    .sheet .body{ padding: 14px 18px 18px; display: grid; gap: 12px }
    .row{ display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center }
    .range{ width: 240px }

    /* =====================================================================
       8) TOAST
       ===================================================================== */
    .toast{ position: fixed; bottom: 16px; left: 50%; translate: -50% 0; background: var(--card); color: var(--ink); border: 1px solid var(--ring); padding: 10px 14px; border-radius: 999px; box-shadow: var(--shadow); opacity: 0; transition: .3s ease }
    .toast.show{ opacity: 1; translate: -50% -8px }

    /* =====================================================================
       9) REDUCED MOTION SUPPORT
       ===================================================================== */
    @media (prefers-reduced-motion: reduce){
      .photo{ transition: none }
      .message{ transition: none }
      .lily g{ animation: none }
      .bg-shimmer{ animation: none }
    }
  </style>
</head>
<body>
  <!-- background shimmer layer -->
  <div class="bg-shimmer" aria-hidden="true"></div>

  <div class="wrap">
    <main class="card" aria-live="polite">
      <!-- Decorative lilies on the card corners -->
      <svg class="lily lily-1" viewBox="0 0 200 200" aria-hidden="true">
        <g fill="none" stroke="#ff7fb6" stroke-width="2.6">
          <ellipse cx="100" cy="68" rx="22" ry="44" transform="rotate(12 100 68)"/>
          <ellipse cx="62" cy="100" rx="22" ry="44" transform="rotate(-28 62 100)"/>
          <ellipse cx="138" cy="100" rx="22" ry="44" transform="rotate(28 138 100)"/>
          <ellipse cx="100" cy="132" rx="22" ry="44" transform="rotate(-12 100 132)"/>
          <circle cx="100" cy="100" r="14" fill="#ffcfe4" stroke="#ff7fb6"/>
          <path d="M100 86v-18M100 114v18M86 100H68M132 100h18"/>
        </g>
      </svg>
      <svg class="lily lily-2" viewBox="0 0 200 200" aria-hidden="true">
        <g fill="none" stroke="#ff7fb6" stroke-width="2.6">
          <ellipse cx="100" cy="68" rx="22" ry="44" transform="rotate(-6 100 68)"/>
          <ellipse cx="62" cy="100" rx="22" ry="44" transform="rotate(22 62 100)"/>
          <ellipse cx="138" cy="100" rx="22" ry="44" transform="rotate(-22 138 100)"/>
          <ellipse cx="100" cy="132" rx="22" ry="44" transform="rotate(6 100 132)"/>
          <circle cx="100" cy="100" r="14" fill="#ffcfe4" stroke="#ff7fb6"/>
          <path d="M100 86v-18M100 114v18M86 100H68M132 100h18"/>
        </g>
      </svg>

      <!-- HEADER -->
      <header>
        <div class="brand" aria-label="Countdown brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Riyaâ€™s Birthday Countdown â€” Pink Lilies</h1>
        </div>
        <div class="actions">
          <div class="days" id="daysWrap" title="Days left">
            <span class="big" id="daysLeft">â€”</span>
            <span class="label">days left</span>
          </div>
          <div class="timer" aria-label="Live timer to birthday">
            <span class="chunk"><span class="num" id="tDays">â€”</span><span class="unit">d</span></span>
            <span>:</span>
            <span class="chunk"><span class="num" id="tHours">â€”</span><span class="unit">h</span></span>
            <span>:</span>
            <span class="chunk"><span class="num" id="tMinutes">â€”</span><span class="unit">m</span></span>
            <span>:</span>
            <span class="chunk"><span class="num" id="tSeconds">â€”</span><span class="unit">s</span></span>
          </div>
          <button class="btn" id="btnSettings" aria-haspopup="dialog" aria-controls="dialogSettings">Settings</button>
          <button class="btn" id="themeToggle" title="Toggle theme" aria-pressed="false">Theme</button>
        </div>
      </header>

      <!-- HERO -->
      <section class="hero">
        <figure id="figure">
          <img id="photo" alt="Todayâ€™s photo" class="photo" loading="eager" />
          <canvas id="petals"></canvas>
          <canvas id="fx"></canvas>
          <div class="badge" id="badge" title="Updates daily at Nepal midnight">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="#b23c74" stroke-width="2"><ellipse cx="12" cy="6.5" rx="3" ry="5"/><ellipse cx="6.2" cy="12" rx="3" ry="5" transform="rotate(-28 6.2 12)"/><ellipse cx="17.8" cy="12" rx="3" ry="5" transform="rotate(28 17.8 12)"/><ellipse cx="12" cy="17.5" rx="3" ry="5"/><circle cx="12" cy="12" r="2" fill="#ffcfe4"/></g></svg>
            <span id="badgeText">Day â€”</span>
          </div>
          <!-- No visible nav arrows (per request) -->
        </figure>
      </section>

      <!-- CONTENT -->
      <section class="content">
        <div class="date-line"><span class="dot"></span><div id="dateText">â€”</div></div>
        <div class="message-wrap"><div class="message" id="message">â€”</div></div>
        <div class="progress-bar" aria-label="Progress through countdown"><div class="progress" id="progress"></div></div>
        <div class="controls">
          <button class="btn" id="copyLink">Copy todayâ€™s private link</button>
          <button class="btn" id="shareBtn">Share</button>
          <button class="btn" id="btnCacheImages" title="Cache images youâ€™ve viewed for offline">Cache viewed images</button>
        </div>
      </section>

      <div class="footer">
        <div>Pink lilies theme â€¢ <strong>Daily</strong> updates â€¢ Timezone: <strong>Asia/Kathmandu</strong> â€¢ PWA enabled</div>
        <div id="hint"></div>
      </div>
    </main>
  </div>

  <!-- SETTINGS MODAL -->
  <dialog id="dialogSettings" class="modal" aria-labelledby="settingsTitle">
    <form method="dialog" class="sheet" id="settingsSheet">
      <header>
        <h2 id="settingsTitle">Settings</h2>
        <div>
          <button class="btn" value="cancel" id="btnCloseDialog">Close</button>
        </div>
      </header>
      <div class="body">
        <div class="row">
          <div>
            <div><strong>Daily updates</strong></div>
            <small class="muted">Photos & messages switch automatically at <em>Asia/Kathmandu</em> midnight.</small>
          </div>
          <div class="muted" aria-hidden="true">Fixed</div>
        </div>
        <div class="row">
          <div>
            <div><strong>Petal particles</strong></div>
            <small class="muted">Floating lily petals over the hero photo.</small>
          </div>
          <label><input type="checkbox" id="chkPetals" checked/> Enable</label>
        </div>
        <div class="row">
          <div>
            <div><strong>Theme</strong></div>
            <small class="muted">Light or dark. Also available via header button.</small>
          </div>
          <select id="selectTheme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="system">System</option>
          </select>
        </div>
      </div>
    </form>
  </dialog>

  <!-- TOAST -->
  <div class="toast" id="toast" role="status" aria-live="polite">Copied!</div>

  <script>
    "use strict";
    /* =====================================================================
       JS MODULE 0 â€” CONFIG
       ===================================================================== */
    const CONFIG = {
      NAME: 'Riya',
      BIRTHDAY_ISO: '2025-10-15',            // YYYY-MM-DD
      TIMEZONE: 'Asia/Kathmandu',            // target TZ
      TOTAL_DAYS: 65,                        // 65..0
      AUTO_SECONDS: 8,                       // default auto-advance seconds
      SEARCH_PATHS: ['./photos', './img', '.'],
      EXTENSIONS: ['jpg','jpeg','png','webp'],
      PETALS_ENABLED_DEFAULT: true,
    };

    // Messages per day (days-left mapping). Extend freely.
    const MESSAGES = {
      65:'Thank God for those Yashu Yashu memes on Instagram ðŸ¤ Without them, who knows if weâ€™d even be friends?',
      64:'Itâ€™s wild how pain found painâ€¦ and somehow, we we clicked ðŸ’«',
      63:'You were in a bigger mess than me, but you still made space for my nonsense ðŸ’›',
      62:'Youâ€™re short. Likeâ€¦ really short ðŸ“ (donâ€™t fight me).',
      61:'Cutest of them all âœ¨ (Donâ€™t get used to me saying it).',
      60:'You get mad for no reason sometimes ðŸ˜¤ (same here â€” satti batti).',
      59:'You roll your eyes like itâ€™s your favorite hobby ðŸ™„',
      58:'You post pics with me ðŸ“¸ and get mad when I donâ€™t react â€œcorrectlyâ€ ðŸ˜‚',
      57:'You once took like 30 photos in one go. Still not satisfied ðŸ˜',
      56:'You think youâ€™re funnyâ€¦ but your jokes are broken ðŸ«  (still like them tho).',
      55:'You have â€œrandom roastâ€ mode that comes out of nowhere ðŸ”¥',
      54:'Youâ€™re low-key competitive ðŸ and I live for it.',
      53:'You laugh at your own mistakes ðŸ˜…',
      52:'You share snacks ðŸ« (even when you threaten not to).',
      51:'You once gave advice that actually worked ðŸ¤¯',
      50:'Youâ€™ll point out if I have food on my faceâ€¦ politely ðŸ˜‚',
      49:'You celebrate tiny wins ðŸŽ‰',
      48:'Youâ€™re cool with inside jokes that last forever ðŸ«¡',
      47:'That trip we talked about? Letâ€™s make it happen someday âœˆ',
      46:'Before Iâ€™m Rancho, Iâ€™m your bestest friend. Always ðŸ¤ž',
      45:'You laugh with your whole face ðŸ˜„',
      44:'Your smile makes the room brighter ðŸŒ¤',
      43:'You remember small details from conversations ðŸ“',
      42:'You make people feel truly heard ðŸ‘‚',
      41:'Your timing for jokes? Immaculate ðŸŽ¯',
      40:'You listen without interrupting ðŸ«¢',
      39:'You make awkward silences comfortable â˜•',
      38:'Your â€œhmmâ€ is oddly satisfying ðŸ¤”',
      37:'You notice when someoneâ€™s off and check in ðŸ©·',
      36:'You donâ€™t fake-laugh â€” if itâ€™s funny, you laugh ðŸ˜‚',
      35:'You notice even small changes, like a haircut ðŸ’‡â€â™€',
      34:'You make group settings less tense ðŸ¤',
      33:'You see beauty in small, random things ðŸŒ¸',
      32:'Youâ€™ve got a playlist for every mood ðŸŽ¶',
      31:'You make people feel like their opinions matter ðŸ’¬',
      30:'You never pretend to know everything ðŸ“–',
      29:'You remember my favorite drink ðŸ¥¤',
      28:'You point out good weather ðŸŒˆ',
      27:'You drop topics when they need to be dropped ðŸ«¢',
      26:'You send perfectly-timed memes ðŸ“²',
      25:'You make eye contact when you talk ðŸ‘€',
      24:'Your voice gets calm when things get stressful ðŸª·',
      23:'You tell stories that actually keep me hooked ðŸ“–',
      22:'Youâ€™re not afraid to be silly ðŸ¤ª',
      21:'You say â€œthank youâ€ and mean it ðŸ’',
      20:'You never forget birthdays ðŸŽ‚',
      19:'You never let disagreements get personal ðŸ’­',
      18:'Youâ€™re always up for trying something new âœ¨',
      17:'You help without making people feel like a burden ðŸ¤',
      16:'You have that rare â€œcomfort to be aroundâ€ vibe ðŸ›‹',
      15:'Youâ€™ve helped me more than you realize ðŸ“š',
      14:'You forgive even when itâ€™s hard â€” and I know because Iâ€™ve been one of those people ðŸ™ˆ',
      13:'Youâ€™ve been through things and still smile like you own the light â˜€',
      12:'Youâ€™re one of the strongest people I know ðŸ†',
      11:'You make life feel a little lighter, just by being in it ðŸ’«',
      10:'Youâ€™re kind in a way the world needs more of ðŸ’›',
       9:'Youâ€™ve been the best gift Godâ€™s ever given me ðŸŽ',
       8:'You make dreams feel possible ðŸš€',
       7:'Youâ€™re proof that good people still exist ðŸ¤',
       6:'Youâ€™re someone Iâ€™ll always root for, no matter what ðŸ“£',
       5:'Youâ€™re more important than you probably realize ðŸŒ»',
       4:'Youâ€™ve made these 65 days worth it already ðŸŒŸ',
       3:'I couldnâ€™t imagine this year without you ðŸŒ™',
       2:'Tomorrowâ€™s your day â€” but youâ€™ve been worth celebrating every day ðŸ’',
       1:'Happy Birthday Eve ðŸ¥³ The world gets to celebrate you tomorrow. Iâ€™ve been celebrating you for 65 days.',
       0:'Happy Birthday, '+CONFIG.NAME+' ðŸŽ‰ Youâ€™re one of the brightest parts of my life. Every single word in this countdown was just my way of saying you matter â€” more than youâ€™ll ever know. You light up rooms, days, and peopleâ€™s livesâ€¦ mine included ðŸ’›'
    };

    /* =====================================================================
       JS MODULE 1 â€” TIME HELPERS (TZ-accurate, no lib)
       ===================================================================== */
    let TIME_OFFSET_MS = 0; // serverNow - deviceNow (from worldtimeapi)

    async function syncTime(){
      // Skip sync in ?mockDate preview mode
      if (new URL(location.href).searchParams.get('mockDate')) return;
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 3000);
      try{
        const res = await fetch('https://worldtimeapi.org/api/timezone/'+encodeURIComponent(CONFIG.TIMEZONE), { signal: ctrl.signal, cache: 'no-store' });
        if(res.ok){ const data = await res.json(); TIME_OFFSET_MS = Date.parse(data.datetime) - Date.now(); }
      }catch(e){ /* graceful fallback */ }
      finally{ clearTimeout(t); }
    }
    function partsInTZ(date, timeZone){
      const fmt = new Intl.DateTimeFormat('en-GB',{ timeZone, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'});
      const p = fmt.formatToParts(date).reduce((a,x)=> (a[x.type]=x.value,a),{});
      return { y:+p.year, m:+p.month, d:+p.day, hh:+p.hour, mm:+p.minute, ss:+p.second };
    }
    function dateInTZ(date, timeZone){ const p = partsInTZ(date, timeZone); return new Date(Date.UTC(p.y, p.m-1, p.d, p.hh, p.mm, p.ss)); }
    function nowInTZ(){
      const mock = new URL(location.href).searchParams.get('mockDate');
      if (mock && /^\d{4}-\d{2}-\d{2}$/.test(mock)) return dateInTZ(new Date(mock+'T00:00:00Z'), CONFIG.TIMEZONE);
      return dateInTZ(new Date(Date.now()+TIME_OFFSET_MS), CONFIG.TIMEZONE);
    }
    function startOfDayTZ(date, tz){ const p = partsInTZ(date, tz); return new Date(Date.UTC(p.y, p.m-1, p.d, 0,0,0)); }
    function getDaysLeft(){
      const nowTZ = nowInTZ();
      const bdayStart = startOfDayTZ(new Date(CONFIG.BIRTHDAY_ISO+'T00:00:00Z'), CONFIG.TIMEZONE);
      const nowStart = startOfDayTZ(nowTZ, CONFIG.TIMEZONE);
      return Math.max(0, Math.ceil((bdayStart - nowStart) / 86400000));
    }
    function niceDate(date){
      return new Intl.DateTimeFormat('en-GB',{ timeZone:CONFIG.TIMEZONE, weekday:'long', year:'numeric', month:'long', day:'numeric' }).format(date);
    }

    /* =====================================================================
       JS MODULE 2 â€” IMAGE LOADER (robust static hosting)
       ===================================================================== */
    function buildCandidates(day){
      const n1 = day;                     // days-left numbering
      const n2 = CONFIG.TOTAL_DAYS - day;        // since-start starting at 0
      const n3 = CONFIG.TOTAL_DAYS - day + 1;    // since-start starting at 1
      const nums = Array.from(new Set([n1,n2,n3]));
      const cand = [];
      for(const dir of CONFIG.SEARCH_PATHS){
        for(const num of nums){
          for(const ext of CONFIG.EXTENSIONS){ cand.push(`${dir}/${num}.${ext}`); }
        }
      }
      return cand;
    }
    function tryLoad(src){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = () => resolve(src);
        img.onerror = () => reject(src);
        img.src = src;
      });
    }
    async function loadPhotoForDay(day){
      const candidates = buildCandidates(day);
      for(const src of candidates){
        try{ await tryLoad(src); return src; }catch(e){ /* keep trying */ }
      }
      return null; // none found
    }
    function inlineLilyPlaceholder(day){
      return `data:image/svg+xml;utf8,${encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1000'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0' stop-color='%23ffd8e9'/>
              <stop offset='1' stop-color='%23ffffff'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' fill='url(%23g)'/>
          <g stroke='%23ff7fb6' fill='none' opacity='.55' stroke-width='4'>
            <ellipse cx='400' cy='350' rx='60' ry='120'/>
            <ellipse cx='300' cy='450' rx='60' ry='120' transform='rotate(-24 300 450)'/>
            <ellipse cx='500' cy='450' rx='60' ry='120' transform='rotate(24 500 450)'/>
            <ellipse cx='400' cy='550' rx='60' ry='120'/>
            <circle cx='400' cy='450' r='24' fill='%23ffcfe4' stroke='%23ff7fb6'/>
          </g>
          <text x='50%' y='86%' text-anchor='middle' font-family='system-ui, -apple-system, Segoe UI' font-size='36' fill='%23b23c74'>Add a ${day}.jpg photo</text>
        </svg>
      `)}`;
    }

    /* =====================================================================
       JS MODULE 3 â€” CONFETTI + PETAL PARTICLES
       ===================================================================== */
    function confettiBurst(){
      const canvas = document.getElementById('fx');
      const ctx = canvas.getContext('2d');
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * devicePixelRatio);
      canvas.height = Math.floor(rect.height * devicePixelRatio);
      const scale = devicePixelRatio;
      const colors = ['#ff4f9a','#ffd166','#06d6a0','#56ccf2','#a78bfa'];
      const N = 140; const parts = [];
      for(let i=0;i<N;i++){
        parts.push({ x:(Math.random()*canvas.width), y:-Math.random()*canvas.height*0.2, vx:(Math.random()-0.5)*3*scale, vy:(Math.random()*3+2)*scale, s:(Math.random()*6+4)*scale, a:Math.random()*Math.PI, va:(Math.random()-0.5)*0.2, c:colors[Math.floor(Math.random()*colors.length)], life:120+Math.random()*80 });
      }
      function tick(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.a+=p.va; p.vy+=0.04*scale; p.life--; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.globalAlpha=Math.max(0,p.life/200); ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore(); });
        for(let i=parts.length-1;i>=0;i--) if(parts[i].life<=0 || parts[i].y>canvas.height+40*scale) parts.splice(i,1);
        if(parts.length>0) requestAnimationFrame(tick); else ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      tick();
    }

    // Gentle lily petal particles drifting downward
    const Petals = (()=>{
      let enabled = CONFIG.PETALS_ENABLED_DEFAULT;
      let raf = null; let parts = []; let ctx, canvas, scale;

      function init(){
        canvas = document.getElementById('petals');
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * devicePixelRatio);
        canvas.height = Math.floor(rect.height * devicePixelRatio);
        ctx = canvas.getContext('2d');
        scale = devicePixelRatio;
        parts = [];
        for(let i=0;i<40;i++) parts.push(make());
      }
      function make(){
        return { x: Math.random()*canvas.width,
                 y: Math.random()*canvas.height,
                 vx: (Math.random()-0.5)*0.2*scale,
                 vy: (0.3 + Math.random()*0.6)*scale,
                 r: (8 + Math.random()*14)*scale,
                 a: Math.random()*Math.PI*2,
                 va: (Math.random()-0.5)*0.02,
                 hue: 330 + Math.random()*20 };
      }
      function drawPetal(p){
        ctx.save();
        ctx.translate(p.x, p.y); ctx.rotate(p.a);
        const w = p.r*1.3, h = p.r*2.2;
        const grad = ctx.createLinearGradient(-w, -h, w, h);
        grad.addColorStop(0, `hsla(${p.hue}, 90%, 88%, .9)`);
        grad.addColorStop(1, `hsla(${p.hue}, 70%, 75%, .6)`);
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(0, -h*0.6);
        ctx.quadraticCurveTo(-w*0.8, -h*0.2, -w*0.3, h*0.5);
        ctx.quadraticCurveTo(0, h*0.9, w*0.3, h*0.5);
        ctx.quadraticCurveTo(w*0.8, -h*0.2, 0, -h*0.6);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }
      function tick(){
        if(!enabled) return; // donâ€™t draw if disabled
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const p of parts){
          p.x += p.vx; p.y += p.vy; p.a += p.va;
          if(p.y - p.r > canvas.height){ p.x = Math.random()*canvas.width; p.y = -p.r*2; }
          drawPetal(p);
        }
        raf = requestAnimationFrame(tick);
      }
      function start(){ if(raf) cancelAnimationFrame(raf); init(); enabled && (raf = requestAnimationFrame(tick)); }
      function stop(){ if(raf) cancelAnimationFrame(raf); const c = document.getElementById('petals'); const cx = c.getContext('2d'); cx && cx.clearRect(0,0,c.width,c.height); }
      function setEnabled(v){ enabled = !!v; if(enabled) start(); else stop(); }
      return { start, stop, setEnabled };
    })();

    /* =====================================================================
       JS MODULE 4 â€” STATE & RENDER
       ===================================================================== */
    let currentDay;           // which day is being displayed (0..TOTAL_DAYS)
    let confettiFired=false;  // ensures confetti triggers once at birthday
    let autoTimer=null;       // auto-advance interval

    function todayDay(){ return Math.min(CONFIG.TOTAL_DAYS, Math.max(0, getDaysLeft())); }

    function setProgress(day){
      const done = (CONFIG.TOTAL_DAYS - day) / CONFIG.TOTAL_DAYS; // 0..1
      document.getElementById('progress').style.width = Math.max(0, Math.min(1, done))*100 + '%';
    }

    function setMessage(text){
      const el = document.getElementById('message');
      el.classList.add('leaving');
      setTimeout(()=>{ el.textContent = text; el.classList.remove('leaving'); }, 180);
    }

    async function render(day){
      currentDay = Math.min(CONFIG.TOTAL_DAYS, Math.max(0, day));
      const daysLeft = currentDay; // by design, day==days-left
      document.getElementById('daysLeft').textContent = daysLeft;
      document.getElementById('badgeText').textContent = 'Day '+currentDay;
      document.getElementById('dateText').textContent = niceDate(nowInTZ());
      setMessage(MESSAGES[currentDay] ?? 'â€”');
      setProgress(currentDay);

      const photoEl = document.getElementById('photo');
      const found = await loadPhotoForDay(currentDay);
      if(found){ photoEl.src = found; photoEl.alt = `Day ${currentDay} photo`; maybePreloadNext(currentDay); }
      else { photoEl.src = inlineLilyPlaceholder(currentDay); photoEl.alt = 'Placeholder image'; }

      // Confetti exactly on birthday day (0)
      if(todayDay()===0 && currentDay===0 && !confettiFired){ confettiFired=true; confettiBurst(); }
      updateHint();
    }

    // Preload the next expected image to reduce flicker
    async function maybePreloadNext(day){
      const next = day-1; if(next < 0) return; const src = await loadPhotoForDay(next); if(!src) return; const img = new Image(); img.src = src; }

    function updateHint(){ const h = document.getElementById('hint'); h.textContent = `Showing today only â€¢ Day ${currentDay} (updates at Nepal midnight)`; }

    function pad(n){ return String(n).padStart(2,'0'); }
    function updateLiveTimer(){
      const now = nowInTZ();
      const target = startOfDayTZ(new Date(CONFIG.BIRTHDAY_ISO+'T00:00:00Z'), CONFIG.TIMEZONE);
      let diff = Math.max(0, target - now);
      const d = Math.floor(diff / 86400000); diff -= d*86400000;
      const h = Math.floor(diff / 3600000); diff -= h*3600000;
      const m = Math.floor(diff / 60000); diff -= m*60000;
      const s = Math.floor(diff / 1000);
      document.getElementById('tDays').textContent = d;
      document.getElementById('tHours').textContent = String(h).padStart(2,'0');
      document.getElementById('tMinutes').textContent = String(m).padStart(2,'0');
      document.getElementById('tSeconds').textContent = String(s).padStart(2,'0');
      const liveDay = todayDay();
      if(liveDay !== currentDay){
        confettiFired = false; // allow confetti at day 0
        render(liveDay);
      }
    }

    // Simple toast utility
    function toast(msg){ const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1400); }

    /* =====================================================================
       JS MODULE 5 â€” THEME & SETTINGS
       ===================================================================== */
    function applyTheme(mode){
      if(mode === 'system'){
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.dataset.theme = prefersDark ? 'dark' : 'light';
      } else document.documentElement.dataset.theme = mode;
    }
    function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
    function read(k, fallback){ try{ const v = JSON.parse(localStorage.getItem(k)); return (v===null||v===undefined)? fallback : v; }catch(e){ return fallback; } }

    function initTheme(){
      const pref = read('theme', 'light');
      applyTheme(pref);
      const select = document.getElementById('selectTheme');
      select.value = pref;
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        const cur = document.documentElement.dataset.theme;
        const next = (cur==='dark')? 'light' : 'dark';
        document.getElementById('themeToggle').setAttribute('aria-pressed', String(next==='dark'));
        applyTheme(next); save('theme', next); select.value = next;
      });
      select.addEventListener('change', ()=>{ applyTheme(select.value); save('theme', select.value); });
    }

    // Settings dialog lifecycle and controls
    function initSettings(){
      const dlg = document.getElementById('dialogSettings');
      const btnOpen = document.getElementById('btnSettings');
      const btnClose = document.getElementById('btnCloseDialog');
      const chkPetals = document.getElementById('chkPetals');

      const savedPetals = read('petals', CONFIG.PETALS_ENABLED_DEFAULT);
      if(chkPetals){ chkPetals.checked = !!savedPetals; Petals.setEnabled(chkPetals.checked); }

      btnOpen.addEventListener('click', ()=>{ dlg.showModal(); trapFocus(dlg); });
      btnClose.addEventListener('click', ()=> dlg.close());
      dlg.addEventListener('click', (e)=>{ if(e.target===dlg) dlg.close(); });

      if(chkPetals){ chkPetals.addEventListener('change', ()=>{ save('petals', chkPetals.checked); Petals.setEnabled(chkPetals.checked); }); }
    }

    // focus trap for dialog
    function trapFocus(dlg){
      const FOCUSABLE = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
      const nodes = dlg.querySelectorAll(FOCUSABLE);
      if(!nodes.length) return;
      const first = nodes[0], last = nodes[nodes.length-1];
      function onKey(e){ if(e.key!=='Tab') return; if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); } else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); } }
      dlg.addEventListener('keydown', onKey);
      setTimeout(()=> first.focus(), 0);
      dlg.addEventListener('close', ()=> dlg.removeEventListener('keydown', onKey), { once: true });
    }

    /* =====================================================================
       JS MODULE 6 â€” SHARING & LINKS
       ===================================================================== */
    function dailyKey(){ const p = partsInTZ(nowInTZ(), CONFIG.TIMEZONE); return `${p.y}-${String(p.m).padStart(2,'0')}-${String(p.d).padStart(2,'0')}`; }
    function encodeTodayLink(day){ const token = btoa(`${dailyKey()}|${day}`); const url = new URL(location.href); url.searchParams.set('t', token); return url.toString(); }

    function initShare(){
      document.getElementById('copyLink').addEventListener('click', ()=>{
        const url = encodeTodayLink(todayDay());
        navigator.clipboard?.writeText(url).then(()=>toast('Link copied')).catch(()=>toast('Copy failed'));
      });
      document.getElementById('shareBtn').addEventListener('click', async ()=>{
        const url = encodeTodayLink(todayDay());
        if(navigator.share){ try{ await navigator.share({ title: CONFIG.NAME+"â€™s Countdown", text: "Today's note", url }); }catch(e){} }
        else { navigator.clipboard?.writeText(url); toast('Link copied'); }
      });
    }

    /* =====================================================================
       JS MODULE 7 â€” AUTO ADVANCE + PARALLAX
       ===================================================================== */
    let AUTO_SECONDS = 86400; // unused in daily-only mode
    function restartAuto(){ /* no-op in daily mode */ }

    function initParallax(){
      const fig = document.getElementById('figure');
      const img = document.getElementById('photo');
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(reduce) return; // respect users
      fig.addEventListener('mousemove', (e)=>{
        const r = fig.getBoundingClientRect();
        const cx = r.left + r.width/2, cy = r.top + r.height/2;
        const dx = (e.clientX - cx)/r.width; const dy = (e.clientY - cy)/r.height;
        img.style.setProperty('--rx', (dy*-6)+'deg');
        img.style.setProperty('--ry', (dx*6)+'deg');
        img.classList.add('parallax');
      });
      fig.addEventListener('mouseleave', ()=>{ img.classList.remove('parallax'); img.style.removeProperty('--rx'); img.style.removeProperty('--ry'); });
    }

    /* =====================================================================
       JS MODULE 8 â€” PWA: SERVICE WORKER REGISTRATION & CACHING
       ===================================================================== */
    function registerSW(){
      if(!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE = 'lilies-v1';
        self.addEventListener('install', (e)=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); });
        self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', (e)=>{
          const url = new URL(e.request.url);
          // cache-first for same-origin images and root document
          if(url.origin===location.origin && (url.pathname==='/' || url.pathname.endsWith('.html') || url.pathname.match(/\.(?:png|jpg|jpeg|webp)$/)) ){
            e.respondWith(caches.open(CACHE).then(async c=>{ const hit = await c.match(e.request); if(hit) return hit; const res = await fetch(e.request); if(res && res.ok) c.put(e.request, res.clone()); return res; }));
          }
        });
      `;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(()=>{});
    }

    function initImageCaching(){
      const btn = document.getElementById('btnCacheImages');
      if(!('caches' in window)) { btn.style.display='none'; return; }
      btn.addEventListener('click', async ()=>{
        try{
          const c = await caches.open('lilies-v1');
          const day = currentDay;
          const list = [day, day-1, day-2, day-3].filter(x=>x>=0);
          const files = (await Promise.all(list.map(loadPhotoForDay))).filter(Boolean);
          await Promise.all(files.map(src=> c.add(src).catch(()=>{})));
          toast('Cached images for offline');
        }catch(e){ toast('Cache not available'); }
      });
    }

    /* =====================================================================
       JS MODULE 9 â€” INIT
       ===================================================================== */
    async function boot(){
      await syncTime();
      initTheme();
      initSettings();
      initShare();
      initParallax();
      registerSW();
      initImageCaching();

      Petals.start();

      await render(todayDay());
      updateLiveTimer();
      setInterval(updateLiveTimer, 1000);
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ render(todayDay()); } });
    }

    // Kickoff
    boot();
  </script>
</body>
</html>
